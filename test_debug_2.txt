2025-11-22 10:56:22.378781: I tensorflow/core/util/port.cc:153] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2025-11-22 10:56:23.310403: I tensorflow/core/util/port.cc:153] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
============================= test session starts =============================
platform win32 -- Python 3.12.6, pytest-8.4.2, pluggy-1.5.0 -- C:\Python312\python.exe
cachedir: .pytest_cache
hypothesis profile 'default' -> database=DirectoryBasedExampleDatabase(WindowsPath('C:/Users/dmedl/Projects/Theoria/.hypothesis/examples'))
rootdir: C:\Users\dmedl\Projects\Theoria
configfile: pyproject.toml
plugins: anyio-4.11.0, Faker-25.9.2, hypothesis-6.124.6, cov-5.0.0, flask-1.3.0, subtests-0.14.2, timeout-2.3.1, schemathesis-3.39.16
collecting ... collected 1 item

tests/integration/test_documents_api.py::test_documents_api_with_real_database_transaction DEBUG: SETTINGS_SECRET_KEY env: integration-secret
DEBUG: settings.settings_secret_key: integration-secret
DEBUG: THEO_API_KEYS env: ["pytest-default-key"]
DEBUG: settings.api_keys: ['pytest-default-key']
DEBUG: Authenticating key='pytest-default-key' against allowed={'dev-Q3O1i8gCWtX7B8BuLgZ0KvGOuB3M8tVOhllcS0K5G9I'}
DEBUG: Key not in allowed keys
FAILED

================================== FAILURES ===================================
______________ test_documents_api_with_real_database_transaction ______________

sqlite_session = <sqlalchemy.orm.session.Session object at 0x0000012B0E3AC380>
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x0000012B0E373F80>

    @pytest.mark.integration
    def test_documents_api_with_real_database_transaction(
        sqlite_session: Session, monkeypatch: pytest.MonkeyPatch
    ) -> None:
        """Ensure document APIs operate against a live transactional database."""
    
        real_get_document = documents_retriever.get_document
    
        def _get_document_with_missing(session: Session, document_id: str):
            if document_id == "missing":
                raise KeyError("Document missing")
            return real_get_document(session, document_id)
    
        monkeypatch.setattr(
            documents_retriever, "get_document", _get_document_with_missing
        )
        monkeypatch.setattr(documents_route, "get_document", _get_document_with_missing)
    
        from theo.application.facades.settings import get_settings
        import os
        print(f"DEBUG: SETTINGS_SECRET_KEY env: {os.environ.get('SETTINGS_SECRET_KEY')}")
        print(f"DEBUG: settings.settings_secret_key: {get_settings().settings_secret_key}")
        print(f"DEBUG: THEO_API_KEYS env: {os.environ.get('THEO_API_KEYS')}")
        print(f"DEBUG: settings.api_keys: {get_settings().api_keys}")
    
        container, registry = resolve_application()
    
        document = Document(
            id=DocumentId("doc-biblical"),
            metadata=DocumentMetadata(
                title="Genesis Commentary",
                source="manuscript",
                language="hebrew",
                created_at=datetime(2024, 1, 1, tzinfo=timezone.utc),
                updated_at=datetime(2024, 1, 1, tzinfo=timezone.utc),
            ),
            scripture_refs=("Gen.1.1",),
            tags=("creation", "theology"),
            checksum="abc123",
        )
        # Ingest into the shared session
        container.ingest_document(document)
    
        # Override the dependency to use our test session
        def _override_session() -> Iterator[Session]:
            yield sqlite_session
    
        app.dependency_overrides[get_session] = _override_session
        try:
            with TestClient(app) as client:
                headers = {"X-API-Key": "pytest-default-key"}
                response = client.get("/documents", headers=headers)
>               assert response.status_code == 200
E               assert 403 == 200
E                +  where 403 = <Response [403 Forbidden]>.status_code

tests\integration\test_documents_api.py:72: AssertionError
------------------------------ Captured log call ------------------------------
WARNING  theo.application.services.geo.seed_openbible_geo:seed_openbible_geo.py:594 OpenBible geo dataset not available at C:\Users\dmedl\Projects\Theoria\theo\data\providers\openbible-geo\data
WARNING  theo.application.facades.settings:settings.py:791 SETTINGS_SECRET_KEY not configured; using insecure fallback for tests
============================== warnings summary ===============================
<frozen importlib._bootstrap>:488
  <frozen importlib._bootstrap>:488: DeprecationWarning: builtin type SwigPyPacked has no __module__ attribute

<frozen importlib._bootstrap>:488
  <frozen importlib._bootstrap>:488: DeprecationWarning: builtin type SwigPyObject has no __module__ attribute

..\..\AppData\Roaming\Python\Python312\site-packages\google\protobuf\internal\well_known_types.py:91
  C:\Users\dmedl\AppData\Roaming\Python\Python312\site-packages\google\protobuf\internal\well_known_types.py:91: DeprecationWarning: datetime.datetime.utcfromtimestamp() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.fromtimestamp(timestamp, datetime.UTC).
    _EPOCH_DATETIME_NAIVE = datetime.datetime.utcfromtimestamp(0)

..\..\AppData\Roaming\Python\Python312\site-packages\testcontainers\core\waiting_utils.py:215
  C:\Users\dmedl\AppData\Roaming\Python\Python312\site-packages\testcontainers\core\waiting_utils.py:215: DeprecationWarning: The @wait_container_is_ready decorator is deprecated and will be removed in a future version. Use structured wait strategies instead: container.waiting_for(HttpWaitStrategy(8080).for_status_code(200)) or container.waiting_for(LogMessageWaitStrategy('ready'))
    @wait_container_is_ready()

..\..\AppData\Roaming\Python\Python312\site-packages\testcontainers\postgres\__init__.py:90
  C:\Users\dmedl\AppData\Roaming\Python\Python312\site-packages\testcontainers\postgres\__init__.py:90: DeprecationWarning: The @wait_container_is_ready decorator is deprecated and will be removed in a future version. Use structured wait strategies instead: container.waiting_for(HttpWaitStrategy(8080).for_status_code(200)) or container.waiting_for(LogMessageWaitStrategy('ready'))
    @wait_container_is_ready()

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
============================== slowest durations ==============================
2.67s call     tests/integration/test_documents_api.py::test_documents_api_with_real_database_transaction
1.31s setup    tests/integration/test_documents_api.py::test_documents_api_with_real_database_transaction

(1 durations < 0.05s hidden.)
=========================== short test summary info ===========================
FAILED tests/integration/test_documents_api.py::test_documents_api_with_real_database_transaction - assert 403 == 200
 +  where 403 = <Response [403 Forbidden]>.status_code
======================== 1 failed, 5 warnings in 5.88s ========================
sys:1: DeprecationWarning: builtin type swigvarlink has no __module__ attribute
