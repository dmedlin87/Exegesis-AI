============================= test session starts =============================
platform win32 -- Python 3.12.6, pytest-8.4.2, pluggy-1.5.0
rootdir: C:\Users\dmedl\Projects\Theoria
configfile: pyproject.toml
plugins: anyio-4.11.0, Faker-25.9.2, hypothesis-6.124.6, cov-5.0.0, flask-1.3.0, subtests-0.14.2, timeout-2.3.1, schemathesis-3.39.16
collected 3 items

tests\services\api\test_app_factory_integration.py F..                   [100%]

================================== FAILURES ===================================
_______________________ test_create_app_with_components _______________________

patched_app_environment = namespace(telemetry_instances=[DummyTelemetry(configured=False)], registered_providers=[DummyTelemetry(configured=Fals...als>.StubContainer object at 0x000001FB8CE88FE0>], health_summary={'status': 'healthy'}, health_detail={'details': []})
example_router = RouterRegistration(router=<fastapi.routing.APIRouter object at 0x000001FB8CE893A0>, prefix=None, tags=['demo'], requires_security=True)
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x000001FB8CE88A40>

    def test_create_app_with_components(
        patched_app_environment, example_router, monkeypatch: pytest.MonkeyPatch
    ):
        def fake_discover():
            return [example_router]
    
        monkeypatch.setattr(
            "theo.infrastructure.api.app.bootstrap.app_factory.discover_router_registrations",
            fake_discover,
        )
    
        settings = _build_settings()
        app = create_app(settings)
    
        assert patched_app_environment.telemetry_instances
        assert (
            patched_app_environment.registered_providers[0]
            is patched_app_environment.telemetry_instances[0]
        )
        assert patched_app_environment.resilience_factories
        assert patched_app_environment.principal_configured == [True]
        assert patched_app_environment.application_resolvers
        resolver = patched_app_environment.application_resolvers[0]
        assert resolver() is patched_app_environment.stub_container
        assert patched_app_environment.registry_savers
    
        assert getattr(app.state, "telemetry_provider").configured is False
    
        client = TestClient(app)
    
        summary = client.get("/health")
        assert summary.status_code == 200
        assert summary.json() == patched_app_environment.health_summary
    
        detail = client.get("/health/detail")
        assert detail.status_code == 200
        assert detail.json() == patched_app_environment.health_detail
    
        metrics = client.get("/metrics")
        assert metrics.status_code == 200
        assert metrics.text == "metrics"
        assert metrics.headers["content-type"].startswith("text/plain")
    
        response = client.get("/demo/ping", headers={"X-API-Key": "test-key"})
        assert response.status_code == 200
        body = response.json()
        assert body == {"ok": True, "principal": {"method": "api_key", "subject": "test-key"}}
        assert response.headers["x-trace-id"] == "trace-123"
        assert patched_app_environment.principal_calls == [(None, "configured")]
    
        error_response = client.get("/demo/boom", headers={"X-API-Key": "test-key"})
        assert error_response.status_code == 418
        payload = error_response.json()
        assert payload["error"]["code"] == "EXPLODED"
        assert payload["error"]["hint"] == "Try again"
        assert payload["trace_id"] == "trace-123"
        assert error_response.headers["x-trace-id"] == "trace-123"
    
>       assert patched_app_environment.principal_calls == [(None, "configured"), (None, "configured")]
E       AssertionError: assert [(None, 'configured')] == [(None, 'conf...'configured')]
E         
E         Right contains one more item: (None, 'configured')
E         Use -v to get more diff

tests\services\api\test_app_factory_integration.py:235: AssertionError
------------------------------ Captured log call ------------------------------
WARNING  theo.infrastructure.api.app.bootstrap.app_factory:runtime_checks.py:111 Starting without API credentials because THEO_ALLOW_INSECURE_STARTUP is enabled. Do not use this configuration outside isolated development environments.
WARNING  theo.infrastructure.api.app.bootstrap.app_factory:runtime_checks.py:138 Starting without SETTINGS_SECRET_KEY because THEO_ALLOW_INSECURE_STARTUP is enabled. Secrets will not be persisted securely.
============================== warnings summary ===============================
<frozen importlib._bootstrap>:488
  <frozen importlib._bootstrap>:488: DeprecationWarning: builtin type SwigPyPacked has no __module__ attribute

<frozen importlib._bootstrap>:488
  <frozen importlib._bootstrap>:488: DeprecationWarning: builtin type SwigPyObject has no __module__ attribute

..\..\AppData\Roaming\Python\Python312\site-packages\google\protobuf\internal\well_known_types.py:91
  C:\Users\dmedl\AppData\Roaming\Python\Python312\site-packages\google\protobuf\internal\well_known_types.py:91: DeprecationWarning: datetime.datetime.utcfromtimestamp() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.fromtimestamp(timestamp, datetime.UTC).
    _EPOCH_DATETIME_NAIVE = datetime.datetime.utcfromtimestamp(0)

..\..\AppData\Roaming\Python\Python312\site-packages\testcontainers\core\waiting_utils.py:215
  C:\Users\dmedl\AppData\Roaming\Python\Python312\site-packages\testcontainers\core\waiting_utils.py:215: DeprecationWarning: The @wait_container_is_ready decorator is deprecated and will be removed in a future version. Use structured wait strategies instead: container.waiting_for(HttpWaitStrategy(8080).for_status_code(200)) or container.waiting_for(LogMessageWaitStrategy('ready'))
    @wait_container_is_ready()

..\..\AppData\Roaming\Python\Python312\site-packages\testcontainers\postgres\__init__.py:90
  C:\Users\dmedl\AppData\Roaming\Python\Python312\site-packages\testcontainers\postgres\__init__.py:90: DeprecationWarning: The @wait_container_is_ready decorator is deprecated and will be removed in a future version. Use structured wait strategies instead: container.waiting_for(HttpWaitStrategy(8080).for_status_code(200)) or container.waiting_for(LogMessageWaitStrategy('ready'))
    @wait_container_is_ready()

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
============================ slowest 50 durations =============================
1.15s setup    tests/services/api/test_app_factory_integration.py::test_create_app_with_components
0.19s call     tests/services/api/test_app_factory_integration.py::test_create_app_with_components

(7 durations < 0.05s hidden.)
=========================== short test summary info ===========================
FAILED tests/services/api/test_app_factory_integration.py::test_create_app_with_components
=================== 1 failed, 2 passed, 5 warnings in 3.30s ===================
sys:1: DeprecationWarning: builtin type swigvarlink has no __module__ attribute
