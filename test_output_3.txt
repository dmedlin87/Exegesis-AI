2025-11-22 15:24:23.465155: I tensorflow/core/util/port.cc:153] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2025-11-22 15:24:24.545752: I tensorflow/core/util/port.cc:153] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
============================= test session starts =============================
platform win32 -- Python 3.12.6, pytest-8.4.2, pluggy-1.5.0 -- C:\Python312\python.exe
cachedir: .pytest_cache
hypothesis profile 'default' -> database=DirectoryBasedExampleDatabase(WindowsPath('C:/Users/dmedl/Projects/Theoria/.hypothesis/examples'))
rootdir: C:\Users\dmedl\Projects\Theoria
configfile: pyproject.toml
plugins: anyio-4.11.0, Faker-25.9.2, hypothesis-6.124.6, cov-5.0.0, flask-1.3.0, subtests-0.14.2, timeout-2.3.1, schemathesis-3.39.16
collecting ... DEBUG: environment=test allows_anonymous=True insecure_ok=True api_keys=[]
collected 1 item

tests/integration/test_documents_api.py::test_documents_api_with_real_database_transaction FAILED

================================== FAILURES ===================================
______________ test_documents_api_with_real_database_transaction ______________

sqlite_session = <sqlalchemy.orm.session.Session object at 0x000001BD0E0CC0B0>
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x000001BD0CE51850>

    @pytest.mark.integration
    def test_documents_api_with_real_database_transaction(
        sqlite_session: Session, monkeypatch: pytest.MonkeyPatch
    ) -> None:
        """Ensure document APIs operate against a live transactional database."""
    
        real_get_document = documents_retriever.get_document
    
        def _get_document_with_missing(session: Session, document_id: str):
            if document_id == "missing":
                raise KeyError("Document missing")
            return real_get_document(session, document_id)
    
        monkeypatch.setattr(
            documents_retriever, "get_document", _get_document_with_missing
        )
        monkeypatch.setattr(documents_route, "get_document", _get_document_with_missing)
    
        # Ensure no auto-generated dev key interferes with our configured test API key
        from theo.application.facades.runtime import clear_generated_dev_key
        clear_generated_dev_key()
    
        container, registry = resolve_application()
    
        document = Document(
            id=DocumentId("doc-biblical"),
            metadata=DocumentMetadata(
                title="Genesis Commentary",
                source="manuscript",
                language="hebrew",
                created_at=datetime(2024, 1, 1, tzinfo=timezone.utc),
                updated_at=datetime(2024, 1, 1, tzinfo=timezone.utc),
            ),
            scripture_refs=("Gen.1.1",),
            tags=("creation", "theology"),
            checksum="abc123",
        )
        # Patch get_session so the service layer uses our transaction-bound session
        monkeypatch.setattr("theo.application.facades.database.get_session", lambda: sqlite_session)
    
        container.ingest_document(document)
    
        def _override_session() -> Iterator[Session]:
            # Use the session from the fixture which is wrapped in a transaction
            yield sqlite_session
    
        app.dependency_overrides[get_session] = _override_session
        try:
            with TestClient(app) as client:
                headers = {"X-API-Key": "pytest-default-key"}
                response = client.get("/documents", headers=headers)
                assert response.status_code == 200
                payload = response.json()
                assert payload["items"], "Expected document results"
                payload = response.json()
                assert payload["items"], "Expected document results"
    
                # Find our document in the results (there might be baseline docs)
                found_doc = next((item for item in payload["items"] if item["id"] == str(document.id)), None)
>               assert found_doc is not None, f"Document {document.id} not found in results"
E               AssertionError: Document doc-biblical not found in results
E               assert None is not None

tests\integration\test_documents_api.py:77: AssertionError
------------------------------ Captured log call ------------------------------
WARNING  theo.application.services.geo.seed_openbible_geo:seed_openbible_geo.py:594 OpenBible geo dataset not available at C:\Users\dmedl\Projects\Theoria\theo\data\providers\openbible-geo\data
WARNING  theo.application.facades.settings:settings.py:791 SETTINGS_SECRET_KEY not configured; using insecure fallback for tests
============================== warnings summary ===============================
<frozen importlib._bootstrap>:488
  <frozen importlib._bootstrap>:488: DeprecationWarning: builtin type SwigPyPacked has no __module__ attribute

<frozen importlib._bootstrap>:488
  <frozen importlib._bootstrap>:488: DeprecationWarning: builtin type SwigPyObject has no __module__ attribute

..\..\AppData\Roaming\Python\Python312\site-packages\google\protobuf\internal\well_known_types.py:91
  C:\Users\dmedl\AppData\Roaming\Python\Python312\site-packages\google\protobuf\internal\well_known_types.py:91: DeprecationWarning: datetime.datetime.utcfromtimestamp() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.fromtimestamp(timestamp, datetime.UTC).
    _EPOCH_DATETIME_NAIVE = datetime.datetime.utcfromtimestamp(0)

..\..\AppData\Roaming\Python\Python312\site-packages\testcontainers\core\waiting_utils.py:215
  C:\Users\dmedl\AppData\Roaming\Python\Python312\site-packages\testcontainers\core\waiting_utils.py:215: DeprecationWarning: The @wait_container_is_ready decorator is deprecated and will be removed in a future version. Use structured wait strategies instead: container.waiting_for(HttpWaitStrategy(8080).for_status_code(200)) or container.waiting_for(LogMessageWaitStrategy('ready'))
    @wait_container_is_ready()

..\..\AppData\Roaming\Python\Python312\site-packages\testcontainers\postgres\__init__.py:90
  C:\Users\dmedl\AppData\Roaming\Python\Python312\site-packages\testcontainers\postgres\__init__.py:90: DeprecationWarning: The @wait_container_is_ready decorator is deprecated and will be removed in a future version. Use structured wait strategies instead: container.waiting_for(HttpWaitStrategy(8080).for_status_code(200)) or container.waiting_for(LogMessageWaitStrategy('ready'))
    @wait_container_is_ready()

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
============================ slowest 50 durations =============================
2.40s call     tests/integration/test_documents_api.py::test_documents_api_with_real_database_transaction
1.22s setup    tests/integration/test_documents_api.py::test_documents_api_with_real_database_transaction

(1 durations < 0.05s hidden.)
=========================== short test summary info ===========================
FAILED tests/integration/test_documents_api.py::test_documents_api_with_real_database_transaction
!!!!!!!!!!!!!!!!!!!!!!!!!! stopping after 1 failures !!!!!!!!!!!!!!!!!!!!!!!!!!
======================== 1 failed, 5 warnings in 5.76s ========================
sys:1: DeprecationWarning: builtin type swigvarlink has no __module__ attribute
